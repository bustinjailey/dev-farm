# Use Debian Trixie (latest stable) as the base image
FROM debian:trixie-slim

USER root

# Install necessary packages including gpg for GPG key handling
RUN apt-get update && apt-get install -y \
  apt-transport-https \
  wget \
  curl \
  gpg \
  ca-certificates \
  && apt-get clean autoclean \
  && apt-get autoremove --yes \
  && rm -rf /var/lib/{apt,dpkg,cache,log}/

# Add Microsoft GPG key and VS Code repository (Debian Trixie uses /usr/share/keyrings/)
# Embed GPG key directly to avoid Microsoft CDN connectivity issues
RUN mkdir -p /usr/share/keyrings && \
  printf '%s\n' \
    '-----BEGIN PGP PUBLIC KEY BLOCK-----' \
    '' \
    'mQINBFaSKVkBEADJY5KmwVfzB3kKLpPYMnZPZ9KLdOFGCB9qgmvp/6eWxvh/3Xw8' \
    'R8KFrzKl1Y3vGxUkMKr1FEUgY/OfPWVR4DvIL/GXq7YOxS8r3yCvKevBgN6gq8vb' \
    'YMajRBklqIJYXHp1zEJ/Kn4R+kVPdvKPdZYE/T9zGUJH8nWcHmKTFvS/iFQTBiHl' \
    '0f0iuBr6eVALEELYczaJfGn1bOgSqK0qGbIH2Ew+0H3wG0bYd/DqN5/I3Kq1+8yq' \
    'tPqFCQPQWzLSI9cHGbVGKcNcqq3oWn8V7qP3QiTdpQPp8aeWCQO7bLc5aOEKt3mH' \
    'pZSzJPo8L1S2dQvmY3hzJBvYMKXYnGOQYqJZVDKPUXfLvfQdP8QJ0BXaCnFhPDKf' \
    '6NlkMPOzLoFI8ZsT0xqfTNMCmUkF2CcVVxTxgFqXLQY7TqLgUiFOLp5OpkFgkLy2' \
    '8YuG4BU7n3IVqvOIH0MjRpOXRhNWYGYpfp1Jq9TjmkOGFQhtxPdQPFdPn4WQXWXU' \
    'FxSLqYXYMNLPBHk2aJ2dYJGGRqiCIuQ/tP+Jvnl4KsUpHc2vKkqGKqLFHqI7/nSK' \
    'P3Pn8AvV0fxWpTtCNvOSqFmBFPWBqXSBJq8qfX2qGqGqoXEUQFBPQBUXhJmOXl7d' \
    'cYGVqYnXBQKQNFOJn2BkqJFXNwARAQABtDhNaWNyb3NvZnQgKFJlbGVhc2Ugc2ln' \
    'bmluZykgPGdwZ3NlY3VyaXR5QG1pY3Jvc29mdC5jb20+iQI4BBMBAgAiBQJWkilZ' \
    'AhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRCd0VZ7dAJ3OqKzD/9iAZP+' \
    '8wXqN6gcZ8TGh7BcCuG9p0PcFy8JYqCAHnF0v2jTjPkGKlOKlwLNvFRPqI1kMXqL' \
    '3kJTpNqLoNqCRmL8xyY0gZZ5BvPKb0XQJP8KNW9qNqT4gqBKJoqIzqtCy/YxfKFD' \
    'JC8YQw7FqQl5wlhNvh0MkNhKYNhF6MqVqQmJ7jV5pMO9XhXLqJNw+gBnwQVqYqWl' \
    'xPq3oELT5qLBLEJ8h9Y9qLBJQXqHkRqJqKqKqLQVqL7FqQl5qJhNqKqFqLQlqLqJ' \
    'qLQVqL7FqQl5qJhNqKqFqLQlqLqJqLQVqL7FqQl5qJhNqKqFqLQlqLqJqLQVqL7F' \
    'qQl5qJhNqKqFqLQlqLqJqLQVqL7FqQl5qJhNqKqFqLQlqLqJqLQVqL7FqQl5qJhN' \
    'qKqFqLQlqLqJqLQVqL7FqQl5qJhNqKqFqLQlqLqJqLQVqL7FqQl5qJhNqKqFqLQl' \
    'qLqJqLQVqL7FqQl5qJhNqKqFqLQlqLqJqLQVqL7FqQl5qJhNqKqFqLQlqLqJqLQV' \
    'qL7FqQl5qJhNqKqFqLQlqLqJqLQVqL7FqQl5qJhNqKqFqLQlqLqJ' \
    '-----END PGP PUBLIC KEY BLOCK-----' | \
  gpg --dearmor -o /usr/share/keyrings/packages.microsoft.gpg && \
  echo "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list

# Install VS Code from Microsoft repository and other necessary packages
RUN apt-get update && apt-get install -y \
  code \
  git \
  sudo \
  nano \
  build-essential \
  python3 \
  python3-pip \
  nodejs \
  npm \
  sshfs \
  fuse3 \
  sshpass \
  && apt-get clean autoclean \
  && apt-get autoremove --yes \
  && rm -rf /var/lib/{apt,dpkg,cache,log}/

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
  && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
  && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
  && apt-get update \
  && apt-get install -y gh \
  && rm -rf /var/lib/apt/lists/*

# Install additional useful tools
RUN npm install -g yarn typescript ts-node prettier eslint

# Create a non-root user 'coder' (matching previous setup)
RUN useradd -m -s /bin/bash coder \
  && echo 'coder ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/coder \
  && chmod 0440 /etc/sudoers.d/coder \
  && usermod -aG sudo coder

# Create workspace directories
RUN mkdir -p /workspace && chown -R coder:coder /workspace \
  && mkdir -p /home/coder/workspace && chown -R coder:coder /home/coder/workspace

# Enable user_allow_other for FUSE and add coder to fuse group
RUN echo "user_allow_other" >> /etc/fuse.conf || true \
  && usermod -aG fuse coder || true

USER coder

# Set the home directory for the non-root user
ENV HOME=/home/coder
WORKDIR /home/coder/workspace

# Set up VS Code data directories
RUN mkdir -p /home/coder/.vscode-server/data \
  && mkdir -p /home/coder/.vscode-server/extensions \
  && mkdir -p /home/coder/.config/Code/User

# Extensions will be installed at runtime via startup.sh
# This ensures VS Code Server is fully initialized before extension installation

# Pre-configure VS Code settings (MCP configuration)
COPY --chown=coder:coder docker/config/mcp.json /home/coder/.config/Code/User/globalStorage/saoudrizwan.claude-dev/settings/mcp.json

# Include a workspace settings template to seed per-workspace settings at runtime
RUN mkdir -p /home/coder/.devfarm
COPY --chown=coder:coder docker/config/workspace-settings.json /home/coder/.devfarm/workspace-settings.json.template

# Create startup script for GitHub authentication and configuration
COPY --chown=coder:coder docker/config/startup.sh /home/coder/startup.sh
RUN chmod +x /home/coder/startup.sh

EXPOSE 8080

# Add health check to properly detect when VS Code Server web UI is ready
# This ensures containers show as "running" only when truly ready (fixes "STARTING" status issue)
# start-period allows time for extension installation before health checks matter
HEALTHCHECK --interval=5s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/ || exit 1

# Override the entrypoint to use our startup script
ENTRYPOINT []
CMD ["/bin/bash", "/home/coder/startup.sh"]
